# Homebrew Tap Setup

This document describes how to set up the Homebrew tap repository for DoPlan CLI.

## Overview

The Homebrew tap repository allows users to install DoPlan CLI using Homebrew:

```bash
brew install DoPlan-dev/doplan/doplan
```

## Repository Setup

### 1. Create Homebrew Tap Repository

Create a new GitHub repository named `homebrew-doplan` under the `DoPlan-dev` organization:

1. Go to https://github.com/organizations/DoPlan-dev/repositories/new
2. Repository name: `homebrew-doplan`
3. Description: `Homebrew tap for DoPlan CLI`
4. Visibility: Public
5. Initialize with README: Yes
6. Create repository

### 2. Repository Structure

The repository should have the following structure:

```
homebrew-doplan/
├── Formula/
│   └── doplan.rb
└── README.md
```

### 3. Initial Formula Template

Create `Formula/doplan.rb` with the following template:

```ruby
# typed: false
# frozen_string_literal: true

# This file was generated by GoReleaser. DO NOT EDIT.
class Doplan < Formula
  desc "Project workflow automation tool that transforms app ideas into structured development projects"
  homepage "https://github.com/DoPlan-dev/CLI"
  version "1.0.0"
  license "MIT"

  on_macos do
    if Hardware::CPU.intel?
      url "https://github.com/DoPlan-dev/CLI/releases/download/v1.0.0/doplan_1.0.0_darwin_amd64.tar.gz"
      sha256 "REPLACE_WITH_ACTUAL_SHA256"

      def install
        bin.install "doplan"
      end
    end
    if Hardware::CPU.arm?
      url "https://github.com/DoPlan-dev/CLI/releases/download/v1.0.0/doplan_1.0.0_darwin_arm64.tar.gz"
      sha256 "REPLACE_WITH_ACTUAL_SHA256"

      def install
        bin.install "doplan"
      end
    end
  end

  on_linux do
    if Hardware::CPU.intel? && Hardware::CPU.is_64_bit?
      url "https://github.com/DoPlan-dev/CLI/releases/download/v1.0.0/doplan_1.0.0_linux_amd64.tar.gz"
      sha256 "REPLACE_WITH_ACTUAL_SHA256"

      def install
        bin.install "doplan"
      end
    end
    if Hardware::CPU.arm? && Hardware::CPU.is_64_bit?
      url "https://github.com/DoPlan-dev/CLI/releases/download/v1.0.0/doplan_1.0.0_linux_arm64.tar.gz"
      sha256 "REPLACE_WITH_ACTUAL_SHA256"

      def install
        bin.install "doplan"
      end
    end
  end

  test do
    system "#{bin}/doplan --version"
  end
end
```

### 4. Update README.md

Create a README.md in the tap repository:

```markdown
# homebrew-doplan

Homebrew tap for DoPlan CLI.

## Installation

```bash
brew install DoPlan-dev/doplan/doplan
```

## Documentation

See [DoPlan CLI](https://github.com/DoPlan-dev/CLI) for documentation.
```

## GoReleaser Configuration

The GoReleaser configuration (`.goreleaser.yml`) is already set up to automatically create PRs to the Homebrew tap repository. GoReleaser will automatically generate Homebrew v2 syntax (without deprecated `bottle :unneeded`) with platform-specific install methods:

```yaml
homebrew:
  - name: doplan
    homepage: https://github.com/DoPlan-dev/CLI
    description: Project workflow automation tool
    license: MIT
    tap:
      owner: DoPlan-dev
      name: homebrew-doplan
      token: ${{ .Env.HOMEBREW_TAP_TOKEN }}
    commit_author:
      name: goreleaserbot
      email: noreply@doplan.dev
    folder: Formula
    test: |
      system "#{bin}/doplan --version"
    install: |
      bin.install "doplan"
```

**Note:** GoReleaser automatically generates Homebrew v2 syntax with:
- No deprecated `bottle :unneeded` directive
- Platform-specific `install` methods inside each `on_macos` and `on_linux` block
- Proper architecture checks (`Hardware::CPU.is_64_bit?` for Linux)

## GitHub Token Setup

### 1. Create Personal Access Token

1. Go to https://github.com/settings/tokens
2. Click "Generate new token (classic)"
3. Name: `homebrew-tap-token`
4. Expiration: Choose appropriate expiration
5. Scopes:
   - `repo` (Full control of private repositories)
   - Or `public_repo` (Access public repositories)
6. Generate token
7. Copy the token (you won't see it again)

### 2. Add Token to GitHub Secrets

1. Go to https://github.com/DoPlan-dev/CLI/settings/secrets/actions
2. Click "New repository secret"
3. Name: `HOMEBREW_TAP_TOKEN`
4. Value: Paste the token
5. Click "Add secret"

## Testing Homebrew Formula

### Manual Testing

1. **Add tap locally:**
   ```bash
   brew tap DoPlan-dev/doplan
   ```

2. **Install formula:**
   ```bash
   brew install doplan
   ```

3. **Test installation:**
   ```bash
   doplan --version
   ```

4. **Uninstall:**
   ```bash
   brew uninstall doplan
   ```

### Automated Testing

GoReleaser will automatically:

1. Generate formula during release
2. Create PR to homebrew-doplan repository
3. Update formula with:
   - New version
   - SHA256 checksums
   - Download URLs

## Release Process

When a new release is created:

1. **GoReleaser generates formula** in `dist/homebrew/doplan.rb`
2. **Creates PR** to `DoPlan-dev/homebrew-doplan` repository
3. **PR includes:**
   - Updated formula with new version
   - SHA256 checksums for all platforms
   - Download URLs from GitHub releases

### Manual PR Creation (if needed)

If automated PR creation fails:

1. **Get formula from release:**
   ```bash
   # Download formula from release artifacts
   # Or generate locally:
   goreleaser release --snapshot --clean
   # Formula will be in dist/homebrew/doplan.rb
   ```

2. **Create PR manually:**
   ```bash
   git clone https://github.com/DoPlan-dev/homebrew-doplan.git
   cd homebrew-doplan
   cp /path/to/doplan.rb Formula/
   git checkout -b update-doplan-v1.0.1
   git add Formula/doplan.rb
   git commit -m "Update doplan to v1.0.1"
   git push origin update-doplan-v1.0.1
   # Create PR on GitHub
   ```

## Troubleshooting

### Token Issues

- **Error: "token not found"**
  - Verify `HOMEBREW_TAP_TOKEN` secret exists in GitHub Actions secrets
  - Check token has correct permissions (repo scope)

- **Error: "permission denied"**
  - Verify token has write access to homebrew-doplan repository
  - Check token hasn't expired

### Formula Issues

- **Error: "formula not found"**
  - Verify homebrew-doplan repository exists
  - Check repository name matches `.goreleaser.yml` configuration

- **Error: "SHA256 mismatch"**
  - Verify checksums are correct in formula
  - Check download URLs are accessible

### PR Creation Issues

- **Error: "PR creation failed"**
  - Check GoReleaser logs for details
  - Verify token has PR creation permissions
  - Check if PR already exists for the version

## Resources

- [Homebrew Documentation](https://docs.brew.sh/)
- [Homebrew Formula Cookbook](https://docs.brew.sh/Formula-Cookbook)
- [GoReleaser Homebrew Documentation](https://goreleaser.com/customization/homebrew/)
- [GitHub Personal Access Tokens](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token)

